<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UDO-APAC X ATJ 2025</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; }
    h1 { margin-bottom: 0; }
    h3 { margin-top: 5px; font-weight: normal; font-size: 1rem; }
    #searchInput { width: 60%; max-width: 640px; padding: 10px; margin: 20px 0; text-align: center; }
    .table-wrap { max-height: 72vh; overflow: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: top; }
    th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; }
    .bold { font-weight: bold; }
    .muted { color: #777; }
  </style>
</head>
<body>

  <h1>Recital 2025</h1>
  <h3>LOCATION:<br>
    Recital <br>
    Mediacorp Theatre<br>
    1 Stars Ave, Singapore 138507
  </h3>

  <input type="text" id="searchInput" placeholder="Search..." />

  <div class="table-wrap">
    <table id="data-table">
      <thead>
        <tr id="header-row"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p id="status" class="muted"></p>

  <script>
    $(function () {
      // Map Google Sheet column headers (keys) to table labels.
      // Keys MUST match your CSV/JSON header row exactly.
      const COLUMNS = [
        { key: "Event Type",         label: "Event Type" },
        { key: "Event Day & Date",   label: "Event Day & Date", bold: true },
        { key: "Student Name",       label: "Student Name" },
        { key: "Event Location",     label: "Event Location" },
        { key: "Reporting Time",     label: "Reporting Time", bold: true },
        { key: "Event Time",         label: "Event Time" },
        { key: "Dismissal Time",     label: "Dismissal Time" },
        { key: "Costume",            label: "Costume" },
        { key: "Footwear",           label: "Footwear" },
        { key: "Makeup",             label: "Makeup" },
        { key: "Hair",               label: "Hair" },
        { key: "Dance Routine",      label: "Dance Routine", bold: true },
        { key: "Class Name",         label: "Class Name" },
        { key: "Remarks",            label: "Remarks" }
      ];

      const $status = $("#status");

      function normalize(v) {
        return String(v == null ? "" : v).toLowerCase().trim();
      }

      function buildHeader() {
        const $row = $("#header-row").empty();
        COLUMNS.forEach(col => $row.append(`<th>${col.label}</th>`));
      }

      function renderTable(rows) {
        const $tbody = $("#data-table tbody").empty();

        if (!rows || rows.length === 0) {
          $tbody.append(
            `<tr><td colspan="${COLUMNS.length}" class="muted">No rows to display.</td></tr>`
          );
          return;
        }

        rows.forEach(row => {
          const $tr = $("<tr>");
          COLUMNS.forEach(col => {
            const val = row[col.key];
            const safe = (val !== undefined && val !== null && String(val).trim() !== "") ? val : "N/A";
            $tr.append(`<td class="${col.bold ? "bold" : ""}">${safe}</td>`);
          });
          $tbody.append($tr);
        });
      }

      function filterRows(rows, query) {
        if (!query) return rows;
        return rows.filter(row =>
          COLUMNS.some(col => normalize(row[col.key]).includes(query))
        );
      }

      // Build the header immediately
      buildHeader();

      // Fetch data from your Flask backend
      $.getJSON("/data")
        .done(function (rows) {
          if (!Array.isArray(rows)) {
            $status.text("Unexpected data format from server.");
            renderTable([]);
            return;
          }
          renderTable(rows);

          $("#searchInput").on("input", function () {
            const q = normalize($(this).val());
            renderTable(filterRows(rows, q));
          });

          $status.text(""); // clear any message
        })
        .fail(function (xhr) {
          let msg = "Failed to load data.";
          try {
            const err = JSON.parse(xhr.responseText || "{}");
            if (err.error) msg += ` ${err.error}`;
          } catch (_) {}
          $status.text(msg);
          renderTable([]);
        });
    });
  </script>

</body>
</html>