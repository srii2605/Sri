<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UDO-APAC X ATJ 2025</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 { margin-bottom: 5px; font-size: 2rem; }
    .header-info {
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 20px;
      text-align: center;
    }
    .header-info .subtitle { font-weight: bold; margin: 5px 0; }
    .header-info p { margin: 5px 0; }
    .header-info strong { font-weight: bold; }
    hr { border: none; border-top: 1px solid #ddd; margin: 20px auto; width: 80%; }
    #searchInput {
      width: 60%;
      max-width: 640px;
      padding: 10px;
      margin: 20px 0;
      text-align: center;
    }
    .table-wrap { max-height: 72vh; overflow: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      vertical-align: top;
    }
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .bold { font-weight: bold; }
    .muted { color: #777; }
    a { text-decoration: underline; }
  </style>
</head>
<body>

  <h1>ATJ ANNUAL RECITAL 2025</h1>
  <div class="header-info">
    <p class="subtitle">REHEARSAL &amp; PERFORMANCE SCHEDULE:</p>
    <p>Combined Rehearsals â€“ at ATJ outlets</p>
    <p>
      <strong>In-Studio Tech Rehearsals:</strong><br>
      Performance &amp; Training Centre, 36 Prinsep St, 04-01, S188638
    </p>
    <p>
      <strong>Mediacorp Tech &amp; Show Days:</strong><br>
      The Theatre at Mediacorp, 1 Stars Avenue, S138507
    </p>
  </div>

  <hr>

  <input type="text" id="searchInput" placeholder="Search..." />

  <div class="table-wrap">
    <table id="data-table">
      <thead>
        <tr id="header-row"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p id="status" class="muted"></p>

  <script>
    $(function () {
      // --- CONFIG: your working CSV export URL ---
      const CSV_URL = "https://docs.google.com/spreadsheets/d/1XFHNeTBRvbO9Hu3rt2Sro2vF9sHS_wW6wzH35bJtgu0/export?format=csv&gid=785015495";

      // Keys MUST match your CSV headers exactly
      const COLUMNS = [
        { key: "Event Type",         label: "Event Type" },
        { key: "Event Day & Date",   label: "Event Day & Date", bold: true },
        { key: "Student Name",       label: "Student Name" },
        { key: "Event Location",     label: "Event Location" },
        { key: "Reporting Time",     label: "Reporting Time", bold: true },
        { key: "Event Time",         label: "Event Time" },
        { key: "Dismissal Time",     label: "Dismissal Time" },
        { key: "Costume",            label: "Costume" },
        { key: "Footwear",           label: "Footwear" },
        { key: "Makeup",             label: "Makeup" },
        { key: "Hair",               label: "Hair" },
        { key: "Dance Routine",      label: "Dance Routine", bold: true },
        { key: "Class Name",         label: "Class Name" },
        { key: "Remarks",            label: "Remarks" }
      ];

      // Columns that should render as a fixed-label link if a URL is present
      const LINK_LABELS = {
        "Costume": "Costume Link",
        "Makeup": "Makeup Tutorial",
        "Hair": "Hair Tutorial"
      };
      const LINK_COLUMNS = new Set(Object.keys(LINK_LABELS));
      const URL_RE = /https?:\/\/[^\s<>"')]+/i;

      const $status = $("#status");

      function normalize(v) { return String(v == null ? "" : v).toLowerCase().trim(); }

      function escHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }
      function escAttr(s) { return escHtml(s); }
      function firstUrl(text) {
        const m = URL_RE.exec(String(text || ""));
        return m ? m[0] : null;
      }

      function buildHeader() {
        const $row = $("#header-row").empty();
        COLUMNS.forEach(col => $row.append(`<th>${col.label}</th>`));
      }

      function renderCell(colKey, raw) {
        const val = raw == null ? "" : String(raw).trim();
        if (!val) return "N/A";
        if (LINK_COLUMNS.has(colKey)) {
          const url = firstUrl(val);
          if (url) {
            const label = LINK_LABELS[colKey] || "Link";
            return `<a href="${escAttr(url)}" target="_blank" rel="noopener noreferrer" title="${escAttr(url)}">${escHtml(label)}</a>`;
          }
        }
        return escHtml(val).replace(/\n/g, "<br>");
      }

      function renderTable(rows) {
        const $tbody = $("#data-table tbody").empty();
        if (!rows || rows.length === 0) {
          $tbody.append(`<tr><td colspan="${COLUMNS.length}" class="muted">No rows to display.</td></tr>`);
          return;
        }
        rows.forEach(row => {
          const $tr = $("<tr>");
          COLUMNS.forEach(col => {
            const html = renderCell(col.key, row[col.key]);
            $tr.append(`<td class="${col.bold ? "bold" : ""}">${html}</td>`);
          });
          $tbody.append($tr);
        });
      }

      function filterRows(rows, query) {
        if (!query) return rows;
        return rows.filter(row =>
          COLUMNS.some(col => normalize(row[col.key]).includes(query))
        );
      }

      // --- Robust CSV parsing (handles commas, quotes, newlines) ---
      function csvToRows(text){
        const rows=[]; let cur=[], i=0, field='', inQ=false;
        while(i<text.length){
          const c=text[i];
          if(inQ){
            if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
            if(c==='"'){ inQ=false; i++; continue; }
            field+=c; i++; continue;
          }else{
            if(c==='"'){ inQ=true; i++; continue; }
            if(c===','){ cur.push(field); field=''; i++; continue; }
            if(c==='\n' || c==='\r'){
              if(c==='\r' && text[i+1]==='\n') i++;
              cur.push(field); rows.push(cur); cur=[]; field=''; i++; continue;
            }
            field+=c; i++; continue;
          }
        }
        if(field.length || cur.length){ cur.push(field); rows.push(cur); }
        return rows;
      }

      function csvToObjects(csvText) {
        const rows = csvToRows(csvText);
        if (!rows.length) return [];
        const headers = rows[0].map(h => h.trim());
        return rows.slice(1).map(r => {
          const o = {};
          headers.forEach((h, i) => { o[h] = r[i] ?? ""; });
          return o;
        });
      }

      // --- Init: build header + fetch CSV ---
      buildHeader();

      $.ajax({ url: CSV_URL, dataType: "text", cache: false })
        .done(function (csvText) {
          const rows = csvToObjects(csvText);
          renderTable(rows);

          $("#searchInput").on("input", function () {
            const q = normalize($(this).val());
            renderTable(filterRows(rows, q));
          });

          $status.text("");
        })
        .fail(function () {
          $status.text("Failed to load CSV data.");
          renderTable([]);
        });
    });
  </script>

</body>
</html>
